name: Compile OpenSSL For Android (arm64-v8a)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

env:
  OPENSSL_VERSION: 3.5.2
  WORK_PATH: /home/runner/work/openssl_for_android/openssl_for_android

jobs:
  Compile_OpenSSL_arm64:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Aria2
        run: |
          sudo apt -yqq update
          sudo apt install -yqq aria2

      - name: Download Android NDK r28b
        run: |
          aria2c -o android-ndk-r28b.zip https://dl.google.com/android/repository/android-ndk-r28b-linux.zip
          unzip android-ndk-r28b.zip

      - name: Download OpenSSL
        run: |
          aria2c -o openssl-${{env.OPENSSL_VERSION}}.tar.gz https://github.com/openssl/openssl/releases/download/openssl-${{env.OPENSSL_VERSION}}/openssl-${{env.OPENSSL_VERSION}}.tar.gz
          tar -zxvf openssl-${{env.OPENSSL_VERSION}}.tar.gz

      - name: Compile (arm64-v8a with 16KB alignment)
        run: |
          bash ./openssl_build_new.sh 21 arm64-v8a ${{env.OPENSSL_VERSION}} r28b

      - name: Verify alignment
        run: |
          echo "Checking alignment for libcrypto.so and libssl.so..."
          readelf -l openssl_${{env.OPENSSL_VERSION}}_arm64-v8a/lib/libcrypto.so | grep ALIGN
          readelf -l openssl_${{env.OPENSSL_VERSION}}_arm64-v8a/lib/libssl.so | grep ALIGN

      - name: Package
        run: |
          tar -zcvf OpenSSL_${{env.OPENSSL_VERSION}}_arm64-v8a.tar.gz openssl_${{env.OPENSSL_VERSION}}_arm64-v8a
          echo "release_tag=${{env.OPENSSL_VERSION}}" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/master'
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          tag_name: ${{env.release_tag}}
          files: ${{env.WORK_PATH}}/OpenSSL_${{env.OPENSSL_VERSION}}_arm64-v8a.tar.gz
